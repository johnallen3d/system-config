#!/usr/bin/env bash

# Feishin bottombar updater
# Parses window title: "(State) (track / total) Title — Artist — Feishin"
# Fetches album art from Navidrome via Subsonic API

# Navidrome credentials
NAVIDROME_URL="https://navidrome.jallen7usa.com"
NAVIDROME_USER="jallen7usa"
NAVIDROME_SALT="88adee"
NAVIDROME_TOKEN="db8275be2b57c729ee20b84f9597fc2a"

COVER_ART_PATH="/tmp/feishin-cover.jpg"
last_track=""

fetch_album_art() {
    local search_query="$1"

    # URL encode the query
    local encoded_query
    encoded_query=$(printf '%s' "$search_query" | jq -sRr @uri)

    # Search for the track
    local response
    response=$(curl -sf "${NAVIDROME_URL}/rest/search2?u=${NAVIDROME_USER}&s=${NAVIDROME_SALT}&t=${NAVIDROME_TOKEN}&v=1.16.1&c=bottombar&f=json&query=${encoded_query}&songCount=1")

    if [[ -z "$response" ]]; then
        return 1
    fi

    # Extract coverArt ID
    local cover_id
    cover_id=$(echo "$response" | jq -r '.["subsonic-response"].searchResult2.song[0].coverArt // empty')

    if [[ -z "$cover_id" ]]; then
        return 1
    fi

    # Download cover art (128px for good quality at 0.33 scale)
    curl -sf "${NAVIDROME_URL}/rest/getCoverArt?u=${NAVIDROME_USER}&s=${NAVIDROME_SALT}&t=${NAVIDROME_TOKEN}&v=1.16.1&c=bottombar&id=${cover_id}&size=128" -o "$COVER_ART_PATH"
}

while true; do
    title=$(osascript -e 'tell application "System Events" to get name of first window of process "Feishin"' 2>/dev/null)

    if [[ -z "$title" ]]; then
        bottombar -m --set music drawing=off --set music_art drawing=off
        sleep 5
        continue
    fi

    # Parse state (using unicode since Font Awesome not rendering)
    # Paused: "(Paused) (X / Y) Title..."
    # Playing: "(X / Y) Title..." (no state prefix)
    if [[ "$title" == "(Paused)"* ]]; then
        icon="▶"
    else
        icon="⏸"
    fi

    # Remove state prefix and " — Feishin" suffix, extract track info
    # Paused: "(Paused) (X / Y) Title — Artist — Feishin"
    # Playing: "(X / Y) Title — Artist — Feishin"
    info=$(echo "$title" | sed -E 's/^\(Paused\) //' | sed -E 's/^\([0-9]+ \/ [0-9]+\) //' | sed 's/ — Feishin$//')

    # Split into title and artist (separated by " — ")
    track=$(echo "$info" | sed 's/ — .*//')
    artist=$(echo "$info" | sed 's/.* — //')

    if [[ "$track" == "$artist" ]]; then
        label="$track"
    else
        label="$track • $artist"
    fi

    # Escape quotes
    label=$(echo "$label" | sed "s/'//g")

    # Fetch album art if track changed
    if [[ "$track" != "$last_track" ]]; then
        if fetch_album_art "$track"; then
            bottombar -m --set music_art background.image="$COVER_ART_PATH"
        fi
        last_track="$track"
    fi

    # Update music item
    bottombar -m --set music icon="$icon" icon.drawing=on icon.font="Cascadia Code PL:SemiBold:16.00" label="$label" drawing=on
    bottombar -m --set music_art drawing=on

    sleep 1
done
