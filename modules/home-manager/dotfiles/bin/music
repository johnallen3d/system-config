#!/usr/bin/env bash

# Unified music control script for MPV

MPV_SOCKET="/tmp/mpv-music.sock"
SOCAT="/etc/profiles/per-user/$USER/bin/socat"
DEBUG=false

# Parse --debug flag from anywhere in args
for arg in "$@"; do
    [[ "$arg" == "--debug" ]] && DEBUG=true
done
# Remove --debug from args
args=()
for arg in "$@"; do
    [[ "$arg" != "--debug" ]] && args+=("$arg")
done
set -- "${args[@]}"

cmd() {
    echo "$1" | $SOCAT - "$MPV_SOCKET" 2>/dev/null
}

# Silent version - only outputs in debug mode
cmd_quiet() {
    if $DEBUG; then
        cmd "$1"
    else
        cmd "$1" >/dev/null
    fi
}

case "${1:-}" in
    play)
        cmd_quiet '{ "command": ["set_property", "pause", false] }'
        ;;
    pause)
        cmd_quiet '{ "command": ["set_property", "pause", true] }'
        ;;
    toggle)
        cmd_quiet '{ "command": ["cycle", "pause"] }'
        ;;
    prev)
        cmd_quiet '{ "command": ["playlist-prev"] }'
        ;;
    next)
        cmd_quiet '{ "command": ["playlist-next"] }'
        ;;
    repeat)
        current=$(cmd '{ "command": ["get_property", "loop-playlist"] }' | jq -r '.data')
        if [[ "$current" == "inf" ]]; then
            cmd_quiet '{ "command": ["set_property", "loop-playlist", "no"] }'
            echo "Repeat: off"
        else
            cmd_quiet '{ "command": ["set_property", "loop-playlist", "inf"] }'
            echo "Repeat: on"
        fi
        ;;
    shuffle)
        current=$(cmd '{ "command": ["get_property", "shuffle"] }' | jq -r '.data')
        if [[ "$current" == "true" ]]; then
            cmd_quiet '{ "command": ["set_property", "shuffle", false] }'
            echo "Shuffle: off"
        else
            cmd_quiet '{ "command": ["set_property", "shuffle", true] }'
            echo "Shuffle: on"
        fi
        ;;
    restart)
        cmd_quiet '{ "command": ["set_property", "playlist-pos", 0] }'
        ;;
    jump)
        track_num="$2"
        if [[ -z "$track_num" || ! "$track_num" =~ ^[0-9]+$ ]]; then
            echo "Usage: music jump <track number>"
            exit 1
        fi
        cmd_quiet "{ \"command\": [\"set_property\", \"playlist-pos\", $((track_num - 1))] }"
        ;;
    open)
        path="$2"
        if [[ -z "$path" ]]; then
            echo "Usage: music open <path>"
            exit 1
        fi
        if [[ ! -S "$MPV_SOCKET" ]]; then
            mpv --idle=yes --input-ipc-server="$MPV_SOCKET" &
            sleep 0.2
        fi
        cmd_quiet '{ "command": ["playlist-clear"] }'
        if [[ -d "$path" ]]; then
            # Directory: find all audio files recursively, sorted
            first=true
            while IFS= read -r file; do
                if $first; then
                    cmd_quiet "{ \"command\": [\"loadfile\", \"$file\", \"replace\"] }"
                    first=false
                else
                    cmd_quiet "{ \"command\": [\"loadfile\", \"$file\", \"append\"] }"
                fi
            done < <(find "$path" -type f \( -iname "*.mp3" -o -iname "*.m4a" -o -iname "*.flac" -o -iname "*.opus" -o -iname "*.ogg" -o -iname "*.wav" \) | sort)
        else
            cmd_quiet "{ \"command\": [\"loadfile\", \"$path\", \"replace\"] }"
        fi
        # Shuffle playlist if shuffle mode is enabled
        shuffle_enabled=$(cmd '{ "command": ["get_property", "shuffle"] }' | jq -r '.data')
        if [[ "$shuffle_enabled" == "true" ]]; then
            cmd_quiet '{ "command": ["playlist-shuffle"] }'
        fi
        cmd_quiet '{ "command": ["set_property", "pause", false] }'
        ;;
    status)
        if [[ ! -S "$MPV_SOCKET" ]]; then
            echo "MPV not running"
            exit 1
        fi

        # Get playlist and current position in one response, process entirely in jq
        response=$(cmd '{ "command": ["get_property", "playlist"] }')
        current_pos=$(cmd '{ "command": ["get_property", "playlist-pos"] }' | jq -r '.data')
        count=$(echo "$response" | jq -r '.data | length')

        if [[ "$count" == "0" || "$count" == "null" || -z "$count" ]]; then
            echo "Playlist is empty"
            exit 0
        fi

        printf "%-3s %-25s %-25s %-30s\n" "#" "Artist" "Album" "Track"
        printf "%s\n" "$(printf '%.0s‚îÄ' {1..85})"

        # Single jq call processes ALL tracks - outputs tab-separated: artist, album, track
        # This replaces ~9 subprocess calls per track with 1 total
        echo "$response" | jq -r '
            .data[].filename | split("/") |
            (if length >= 3 then .[-3] else "Unknown" end) as $artist_raw |
            (if length >= 2 then .[-2] else "Unknown" end) as $album_raw |
            (if length >= 1 then .[-1] else "Unknown" end) as $track_raw |
            ($artist_raw | if length > 23 then .[0:20] + "..." else . end) as $artist |
            ($album_raw | if length > 23 then .[0:20] + "..." else . end) as $album |
            ($track_raw | sub("\\.[^.]*$"; "") | sub("^[0-9]+ - [^-]+ - "; "") |
                if length > 28 then .[0:25] + "..." else . end) as $track |
            [$artist, $album, $track] | @tsv
        ' | {
            i=0
            while IFS=$'\t' read -r artist album track; do
                if [[ "$i" == "$current_pos" ]]; then
                    printf "‚ñ∂  \033[1m%-25s %-25s %-30s\033[0m\n" "$artist" "$album" "$track"
                else
                    printf "%-3s %-25s %-25s %-30s\n" "$((i + 1))" "$artist" "$album" "$track"
                fi
                ((i++))
            done
        }

        loop_status=$(cmd '{ "command": ["get_property", "loop-playlist"] }' | jq -r '.data')
        shuffle_status=$(cmd '{ "command": ["get_property", "shuffle"] }' | jq -r '.data')
        if [[ "$loop_status" == "inf" || "$shuffle_status" == "true" ]]; then
            printf "%s\n" "$(printf '%.0s‚îÄ' {1..85})"
            [[ "$loop_status" == "inf" ]] && printf "üîÅ Repeat: on\n"
            [[ "$shuffle_status" == "true" ]] && printf "üîÄ Shuffle: on\n"
        fi
        ;;
    "")
        exec lf "$MUSIC_DIR"
        ;;
    *)
        echo "Usage: music [--debug] [play|pause|toggle|prev|next|repeat|shuffle|restart|jump|status|open <path>]"
        echo "  (no args)  Open music library in lf"
        echo "  play       Resume playback"
        echo "  pause      Pause playback"
        echo "  toggle     Toggle play/pause"
        echo "  prev       Previous track"
        echo "  next       Next track"
        echo "  repeat     Toggle playlist repeat"
        echo "  shuffle    Toggle shuffle mode"
        echo "  restart    Jump to beginning of playlist"
        echo "  jump <n>   Jump to track number n"
        echo "  status     Show current playlist"
        echo "  open       Load file into MPV"
        echo ""
        echo "Options:"
        echo "  --debug    Show JSON responses from MPV"
        exit 1
        ;;
esac
